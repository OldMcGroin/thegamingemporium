{{- $base := .Site.BaseURL -}}
{{- $games := site.Data.games -}}
{{- $recent := where $games "date_added" "ne" "" -}}
{{- $recent = sort $recent "date_added" "desc" -}}

{{ printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:media="http://search.yahoo.com/mrss/">
  <channel>
    <title>{{ .Site.Title }} â€“ Recent Additions</title>
    <link>{{ $base }}</link>
    <atom:link href="{{ "rss.xml" | absURL }}" rel="self" type="application/rss+xml" />
    <description>The 50 most recent additions to The Gaming Emporium (links go to the site first).</description>
    <lastBuildDate>{{ now.UTC.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>

    {{ range first 50 $recent }}
      {{- $title := .title | default "" -}}
      {{- if $title -}}
        {{- $slug := $title | lower | urlize -}}
        {{- $imgPath := printf "/Images/Games/%s.webp" $slug -}}
        {{- $img := $imgPath | absURL -}}
        {{- $ext := .link | default $base -}}
        {{- $siteLink := (printf "game/%s/" $slug) | absURL -}}
        {{- $desc := .notes | default "" -}}
        {{- $cat := .category | default "" -}}
        {{- $pub := time .date_added -}}

        <item>
          <title>{{ $title | htmlEscape }}</title>

          <!-- Link to your site first (per your existing RSS wording) -->
          <link>{{ $siteLink | htmlEscape }}</link>

          <!-- External link is included in the description -->
          <guid isPermaLink="false">{{ $slug }}-{{ .date_added }}</guid>
          <pubDate>{{ $pub.UTC.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</pubDate>

          <!-- Images: multiple formats for best feed-reader compatibility -->
          <media:thumbnail url="{{ $img | htmlEscape }}" />
          <media:content url="{{ $img | htmlEscape }}" medium="image" />
          <enclosure url="{{ $img | htmlEscape }}" type="image/webp" />

          <description><![CDATA[
            <p><a href="{{ $siteLink }}"><img src="{{ $img }}" alt="{{ $title | htmlEscape }}" style="max-width:100%;height:auto;" /></a></p>
            {{ if $desc }}<p>{{ $desc | htmlEscape }}</p>{{ end }}
            {{ if $cat }}<p><strong>Category:</strong> {{ $cat | htmlEscape }}</p>{{ end }}
            {{ if $ext }}<p><strong>External link:</strong> <a href="{{ $ext | htmlEscape }}">{{ $ext | htmlEscape }}</a></p>{{ end }}
          ]]></description>
        </item>
      {{- end -}}
    {{ end }}
  </channel>
</rss>
