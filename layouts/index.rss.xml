{{- $base := .Site.BaseURL -}}
{{- $games := site.Data.games -}}
{{- $recent := where $games "date_added" "ne" "" -}}
{{- $recent = sort $recent "date_added" "desc" -}}

{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\"?>" | safeHTML -}}
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:media="http://search.yahoo.com/mrss/">
  <channel>
    <title>{{ .Site.Title }} â€“ Recent Additions</title>
    <link>{{ $base }}</link>
    <atom:link href="{{ "rss.xml" | absURL }}" rel="self" type="application/rss+xml" />
    <description>The 50 most recent additions to The Gaming Emporium (links go to the site first).</description>
    <lastBuildDate>{{ now.UTC.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>

    {{- range first 50 $recent }}
      {{- $title := .title -}}

      {{/* Slug: match tools/generate_game_pages.py slugify_title() exactly */}}
      {{- $slug := .slug -}}
      {{- if not $slug -}}
        {{- $slug = lower $title -}}
        {{- $slug = replaceRE "[^a-z0-9]+" "-" $slug -}}
        {{- $slug = replaceRE "^-+|-+$" "" $slug -}}
      {{- end -}}

      {{- $pageURL := (printf "/game/%s/" $slug) | absURL -}}

      {{/* Image fallback: .webp -> .png -> .jpg -> .jpeg (include tags only if present) */}}
      {{- $imgRelWebp := printf "/Images/Games/%s.webp" $slug -}}
      {{- $imgRelPng  := printf "/Images/Games/%s.png"  $slug -}}
      {{- $imgRelJpg  := printf "/Images/Games/%s.jpg"  $slug -}}
      {{- $imgRelJpeg := printf "/Images/Games/%s.jpeg" $slug -}}

      {{- $imgRel := "" -}}
      {{- if (fileExists (printf "static%s" $imgRelWebp)) -}}
        {{- $imgRel = $imgRelWebp -}}
      {{- else if (fileExists (printf "static%s" $imgRelPng)) -}}
        {{- $imgRel = $imgRelPng -}}
      {{- else if (fileExists (printf "static%s" $imgRelJpg)) -}}
        {{- $imgRel = $imgRelJpg -}}
      {{- else if (fileExists (printf "static%s" $imgRelJpeg)) -}}
        {{- $imgRel = $imgRelJpeg -}}
      {{- end -}}
      {{- $img := "" -}}
      {{- if $imgRel -}}
        {{- $img = $imgRel | absURL -}}
      {{- end -}}

      <item>
        <title>{{ $title | htmlEscape }}</title>
        <link>{{ $pageURL | htmlEscape }}</link>
        <guid isPermaLink="false">{{ $slug }}-{{ .date_added }}</guid>
        <pubDate>{{ (time .date_added).UTC.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</pubDate>

        {{- if $img }}
        <media:thumbnail url="{{ $img | htmlEscape }}" />
        <media:content url="{{ $img | htmlEscape }}" medium="image" />
        <enclosure url="{{ $img | htmlEscape }}" type="image/*" />
        {{- end }}

        {{- /* Keep description plain-text to avoid XML parser issues; no category/external-link text */ -}}
        <description>{{ if .notes }}{{ .notes | plainify | htmlEscape }}{{ end }}</description>

        {{- /* Optional RSS category field (doesn't clutter Feedly description) */ -}}
        {{- if .category }}<category>{{ .category | htmlEscape }}</category>{{ end }}
      </item>
    {{- end }}
  </channel>
</rss>
