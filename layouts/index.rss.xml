{{- $base := .Site.BaseURL -}}
{{- $games := site.Data.games -}}
{{- $recent := where $games "date_added" "ne" "" -}}
{{- $recent = sort $recent "date_added" "desc" -}}

{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\"?>" | safeHTML -}}
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:media="http://search.yahoo.com/mrss/">
  <channel>
    <title>{{ .Site.Title }} â€“ Recent Additions</title>
    <link>{{ $base }}</link>
    <atom:link href="{{ "rss.xml" | absURL }}" rel="self" type="application/rss+xml" />
    <description>The 50 most recent additions to The Gaming Emporium. (Links go to the site first.)</description>
    <lastBuildDate>{{ now.UTC.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>

    {{- range first 50 $recent }}
      {{- $title := .title -}}
      {{- $slug := $title | lower | urlize -}}
      {{- /* Choose an image for the RSS item (fallback: webp -> png -> jpg -> jpeg). */ -}}
{{- $imgRel := "" -}}
{{- $mime := "" -}}
{{- $pWebp := printf "static/Images/Games/%s.webp" $slug -}}
{{- $pPng  := printf "static/Images/Games/%s.png"  $slug -}}
{{- $pJpg  := printf "static/Images/Games/%s.jpg"  $slug -}}
{{- $pJpeg := printf "static/Images/Games/%s.jpeg" $slug -}}

{{- if fileExists $pWebp -}}
  {{- $imgRel = printf "/Images/Games/%s.webp" $slug -}}
  {{- $mime = "image/webp" -}}
{{- else if fileExists $pPng -}}
  {{- $imgRel = printf "/Images/Games/%s.png" $slug -}}
  {{- $mime = "image/png" -}}
{{- else if fileExists $pJpg -}}
  {{- $imgRel = printf "/Images/Games/%s.jpg" $slug -}}
  {{- $mime = "image/jpeg" -}}
{{- else if fileExists $pJpeg -}}
  {{- $imgRel = printf "/Images/Games/%s.jpeg" $slug -}}
  {{- $mime = "image/jpeg" -}}
{{- end -}}

{{- $img := "" -}}
{{- if ne $imgRel "" -}}
  {{- $img = $imgRel | absURL -}}
{{- end -}}
      {{- $internal := (printf "/game/%s/" $slug) | absURL -}}
      {{- $external := .link -}}
      {{- $desc := "" -}}
      {{- if .notes -}}{{- $desc = .notes -}}{{- end -}}
      <item>
        <title>{{ $title | htmlEscape }}</title>
        <link>{{ $internal | htmlEscape }}</link>
        <guid isPermaLink="true">{{ $internal | htmlEscape }}</guid>
        <pubDate>{{ (time .date_added).UTC.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</pubDate>

        <!-- Images (thumbnail + enclosure) -->
{{- if ne $img "" -}}
        <media:thumbnail url="{{ $img | htmlEscape }}" />
        <media:content url="{{ $img | htmlEscape }}" medium="image" />
        <enclosure url="{{ $img | htmlEscape }}" type="{{ $mime | htmlEscape }}" />
{{- end -}}

        <!-- Plain-text description (avoid CDATA/XML parse issues) -->
        <category>{{ .category | htmlEscape }}</category>
        <description>{{ if $desc }}
{{ $desc | htmlEscape }}
{{ else }}
View this entry on The Gaming Emporium.
{{ end }}</description>
      </item>
    {{- end }}
  </channel>
</rss>
