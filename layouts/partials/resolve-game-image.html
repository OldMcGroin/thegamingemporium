{{/*
Resolve the best available static image path for a game.

Priority:
  1) /Images/Games/<slug>.webp
  2) /Images/Games/<slug>.jpg
  3) /Images/Games/<slug>.png
Fallback:
  /Images/placeholder.jpg

Usage:
  {{ $img := partial "resolve-game-image.html" . }}
*/}}

{{- $g := . -}}

{{/*
  This partial is used in a few contexts:
  - from a Hugo Page (e.g. /game/<slug>/ pages) => .Title / .Params
  - from a dict/map (older generator code paths) => { title: "..." }

  Hugo is case-sensitive: Page has .Title (not .title).
*/}}

{{- $t := "" -}}
{{- $type := printf "%T" $g -}}
{{- if or (strings.Contains $type "hugolib.page") (strings.Contains $type "hugolib.pageState") (strings.Contains $type "page.") -}}
  {{- $t = $g.Title | default "" -}}
  {{- if eq $t "" -}}
    {{- $t = $g.Params.title | default "" -}}
  {{- end -}}
{{- else if reflect.IsMap $g -}}
  {{- $t = (index $g "title") | default "" -}}
{{- else -}}
  {{- $t = $g.Title | default "" -}}
{{- end -}}


{{- $slug := urlize $t -}}
{{- if eq $slug "" -}}
  {{- $slug = "unknown" -}}
{{- end -}}
{{- $img := "/Images/placeholder.jpg" -}}
{{- $exts := slice "webp" "jpg" "png" -}}
{{- range $ext := $exts -}}
  {{- if eq $img "/Images/placeholder.jpg" -}}
    {{- $rel := printf "/Images/Games/%s.%s" $slug $ext -}}
    {{- if fileExists (printf "static%s" $rel) -}}
      {{- $img = $rel -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $img -}}
