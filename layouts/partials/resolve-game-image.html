{{/*
Resolve the best available static image path for a game.

Priority:
  1) /Images/Games/<slug>.webp
  2) /Images/Games/<slug>.jpg
  3) /Images/Games/<slug>.png
Fallback:
  /Images/placeholder.jpg

Usage:
  {{ $img := partial "resolve-game-image.html" . }}
*/}}

{{- $g := . -}}

{{/*
  This partial is used in a few contexts:
  - from a Hugo Page (e.g. /game/<slug>/ pages) => .Title / .Params
  - from a dict/map (older generator code paths) => { title: "..." }

  Hugo is case-sensitive: Page has .Title (not .title).
*/}}

{{- $t := "" -}}
{{- $slug := "" -}}
{{- $explicit := "" -}}
{{- $type := printf "%T" $g -}}

{{- /* Hugo Page */ -}}
{{- if or (strings.Contains $type "hugolib.page") (strings.Contains $type "hugolib.pageState") (strings.Contains $type "page.") -}}
  {{- $t = $g.Title | default "" -}}
  {{- /* If the page has an explicit image param, prefer it */ -}}
  {{- with $g.Params.image -}}
    {{- if ne . "" -}}
      {{- $explicit = . -}}
    {{- end -}}
  {{- end -}}
  {{- /* Use the page URL slug for stability (title can change) */ -}}
  {{- $rp := strings.TrimSuffix "/" ($g.RelPermalink | default "") -}}
  {{- if ne $rp "" -}}
    {{- $slug = path.Base $rp -}}
  {{- end -}}

{{- /* Dict/map (older generator contexts) */ -}}
{{- else if reflect.IsMap $g -}}
  {{- $t = (index $g "title") | default "" -}}
  {{- $slug = urlize $t -}}

{{- else -}}
  {{- $t = $g.Title | default "" -}}
  {{- $slug = urlize $t -}}
{{- end -}}

{{- /* If an explicit image was provided, return it (normalized to a site-root path) */ -}}
{{- if and (ne $explicit "") (not (strings.HasPrefix $explicit "http")) -}}
  {{- if not (strings.HasPrefix $explicit "/") -}}
    {{- $explicit = printf "/%s" $explicit -}}
  {{- end -}}
  {{- /* If it exists in /static, use it */ -}}
  {{- if fileExists (printf "static%s" $explicit) -}}
    {{- $explicit -}}
  {{- else -}}
    {{- /* Still return it; some users keep images only in the deployed site */ -}}
    {{- $explicit -}}
  {{- end -}}
{{- else if and (ne $explicit "") (strings.HasPrefix $explicit "http") -}}
  {{- $explicit -}}
{{- else -}}

{{- if eq $slug "" -}}
  {{- $slug = urlize $t -}}
{{- end -}}
{{- if eq $slug "" -}}
  {{- $slug = "unknown" -}}
{{- end -}}
{{- $img := "/Images/placeholder.jpg" -}}
{{- $exts := slice "webp" "jpg" "png" -}}
{{- range $ext := $exts -}}
  {{- if eq $img "/Images/placeholder.jpg" -}}
    {{- $rel := printf "/Images/Games/%s.%s" $slug $ext -}}
    {{- if fileExists (printf "static%s" $rel) -}}
      {{- $img = $rel -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $img -}}

{{- end -}}
