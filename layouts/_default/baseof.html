<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script>
    (function() {
      try {
        // v5: default to dark and ignore any old stored values from earlier builds
        var key = "tge_theme_v5";
        var stored = localStorage.getItem(key);
        if (!stored) {
          // Clear legacy keys so old "light" values can't force Day mode
          ["tge_theme_v2","tge_theme_v3","tge_theme_v4","theme","site-theme"].forEach(function(k){
            try { localStorage.removeItem(k); } catch(e) {}
          });
        }
        var theme = stored || "dark";
        document.documentElement.setAttribute("data-theme", theme);
      } catch (e) {}
    })();
  </script>
<title>{{ if .IsHome }}{{ site.Title }}{{ else }}{{ .Title }} ¬∑ {{ site.Title }}{{ end }}</title>
  {{/* Open Graph / social cards */}}
  {{ $isGame := or (eq .Type "game") (eq .Section "game") }}

  {{ $ogTitle := .Title }}
  {{ if or (not $ogTitle) (eq $ogTitle "") }}
    {{ $ogTitle = site.Title }}
  {{ end }}

  {{/* Default description */}}
  {{ $ogDesc := .Description }}
  {{ if or (not $ogDesc) (eq $ogDesc "") }}
    {{ $ogDesc = .Summary | plainify }}
  {{ end }}
  {{ if or (not $ogDesc) (eq $ogDesc "") }}
    {{ $ogDesc = site.Params.description }}
  {{ end }}

  {{/* For game pages, build a clean, consistent one-line description */}}
  {{ if $isGame }}
    {{ $cat := "" }}
    {{ with .Params.category }}{{ $cat = (. | replaceRE "-" " " | title) }}{{ end }}
    {{ $series := "" }}
    {{ with .Params.series }}{{ $series = . }}{{ end }}
    {{ $g1 := .Params.genre1 }}{{ $g2 := .Params.genre2 }}
    {{ $genres := "" }}
    {{ if or $g1 $g2 }}
      {{ $genres = delimit (where (slice $g1 $g2) "." "ne" "") ", " }}
    {{ end }}
    {{ $parts := slice }}
    {{ if $cat }}{{ $parts = $parts | append $cat }}{{ end }}
    {{ if $series }}{{ $parts = $parts | append (printf "Series: %s" $series) }}{{ end }}
    {{ if $genres }}{{ $parts = $parts | append (printf "Genre: %s" $genres) }}{{ end }}
    {{ if gt (len $parts) 0 }}
      {{ $ogDesc = delimit $parts " ¬∑ " }}
    {{ end }}
  {{ end }}

  {{ $ogUrl := .Permalink }}

  {{/* Default site share image */}}
  {{ $ogImage := ("/Images/Social/share-preview.jpg?v=4" | absURL) }}
  {{ $ogImageType := "image/jpeg" }}
  {{ $ogImageW := "1200" }}
  {{ $ogImageH := "630" }}
  {{ $ogImageAlt := "The Gaming Emporium preview image" }}

  {{/* For game pages, prefer the game card image so feed readers (Feedly) and social previews show the correct thumbnail */}}
  {{ if $isGame }}
    {{ $img := partial "resolve-game-image.html" . }}
    {{ if $img }}
      {{ $ogImage = ($img | absURL) }}
      {{ $ogImageAlt = (printf "%s cover image" $ogTitle) }}
      {{ $ogImageW = "600" }}
      {{ $ogImageH = "600" }}
      {{ $lower := lower $img }}
      {{ if hasSuffix $lower ".png" }}{{ $ogImageType = "image/png" }}
      {{ else if or (hasSuffix $lower ".jpg") (hasSuffix $lower ".jpeg") }}{{ $ogImageType = "image/jpeg" }}
      {{ else if hasSuffix $lower ".webp" }}{{ $ogImageType = "image/webp" }}
      {{ end }}
    {{ end }}
  {{ end }}

  <link rel="canonical" href="{{ $ogUrl }}" />
  <meta property="og:title" content="{{ $ogTitle }}">
  <meta property="og:description" content="{{ $ogDesc }}">
  <meta property="og:url" content="{{ $ogUrl }}" />
  <meta property="og:type" content="{{ if .IsHome }}website{{ else }}article{{ end }}" />
  <meta property="og:image" content="{{ $ogImage }}">
  <meta property="og:image:secure_url" content="{{ $ogImage }}">
  <meta property="og:image:type" content="{{ $ogImageType }}">
  <meta property="og:image:width" content="{{ $ogImageW }}">
  <meta property="og:image:height" content="{{ $ogImageH }}">
  <meta property="og:image:alt" content="{{ $ogImageAlt }}" />
  <meta property="og:site_name" content="{{ site.Title }}" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ $ogTitle }}" />
  <meta name="twitter:description" content="{{ $ogDesc }}" />
  <meta name="twitter:image" content="{{ $ogImage }}" />

  <meta name="description" content="{{ if $isGame }}{{ $ogDesc }}{{ else }}A curated archive of fan decompilations, PC ports, open-source projects and modern recreations.{{ end }}">

  {{/* Fingerprinted CSS so mobile browsers (and Cloudflare) always pick up the latest styles */}}
  {{ $css := resources.Get "css/main.css" | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}" crossorigin="anonymous" />

  <link rel="alternate" type="application/rss+xml" title="The Gaming Emporium ‚Äî Recent Additions" href="{{ "/rss.xml" | relURL }}" />

  {{/* Preload the large background image to reduce perceived load time */}}
  <link rel="preload" as="image" href="{{ "/Images/Background/background.jpg" | relURL }}" fetchpriority="high" />

  {{/* Page-specific preloads for above-the-fold card images */}}
  {{ block "preloads" . }}{{ end }}

  {{/*
  Map: tracking-id -> external link, used by Most Popular dropdown.
  Supports an optional stable slug override per game (field: "slug" in games.json)
  so title edits don't break Most Popular links.
  */}}
  <script>
    window.__GAMES_BY_SLUG__ = {
      {{- $slugGames := site.Data.games -}}
      {{- if not hugo.IsServer -}}{{- $slugGames = where $slugGames "hidden" "ne" true -}}{{- end -}}
      {{- range $i, $g := $slugGames -}}
        {{- $slug := default (urlize $g.title) $g.slug -}}
        {{- if $i }},{{ end -}}
        {{- printf "%q" $slug -}}: {"title": {{ printf "%q" $g.title }}, "url": {{ printf "%q" $g.link }} }
      {{- end -}}
    };
  </script>
</head>
<body>
<div class="site-bg">
    <div class="site-bg__image" style="background-image:url('{{ "/Images/Background/background.jpg" | relURL }}')"></div>
    <header class="topbar">
      <div class="container topbar__inner">
        <div class="brand">
          <a class="brand__link" href="{{ site.Home.RelPermalink }}">{{ site.Title }}</a>
        </div>

        <div class="topbar__search">
          <input id="siteSearchInput" class="search-input" type="search" placeholder="Search games..." aria-label="Search games" autocomplete="off">
          <div id="siteSearchDropdown" class="search-dropdown" aria-label="Search results" role="listbox"></div>
        </div>


        <button class="theme-toggle theme-toggle--top" type="button" aria-label="Toggle theme" title="Toggle theme" data-theme-toggle>
          <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
        </button>

        <button class="nav-toggle" type="button" aria-label="Menu" aria-expanded="false" data-nav-toggle>
    <svg class="nav-toggle__icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M4 7h16M4 12h16M4 17h16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>
<nav class="nav" data-nav>

          {{ if not .IsHome }}
            <a class="nav__link" href="{{ site.Home.RelPermalink }}">Home</a>
          {{ end }}
          <a class="nav__link" href="{{ partial "section-link.html" "categories" }}">Categories</a>
          <a class="nav__link" href="{{ partial "section-link.html" "recent" }}">Recent Additions</a>
          <a class="nav__link" href="{{ partial "section-link.html" "series" }}">Browse By Series</a>
          <a class="nav__link" href="{{ partial "section-link.html" "genres" }}">Browse By Genre</a>
          <a class="nav__link" href="{{ partial "section-link.html" "all" }}">All</a>
          <div class="nav-popular-wrap">
            <button class="nav__link nav__link--pill" type="button" id="popularBtn" data-popular-toggle aria-haspopup="dialog" aria-expanded="false">
              Most Popular
            </button>
          </div>
          <span class="rss-copy-wrap">
            <button class="nav__link nav__link--pill nav__link--rss" type="button" data-copy-rss aria-label="Copy RSS feed URL" title="Copy RSS feed URL">RSS</button>
            <span class="rss-copied" aria-hidden="true">Copied!</span>
          </span>
        </nav>
      </div>
    </header>

    <!-- Most Popular popover (kept outside the mobile nav so it can open from anywhere) -->
    <div class="nav-popular" id="popularPopover" hidden>
      <div class="nav-popular__head">
        <div class="nav-popular__head-left">
          <div class="nav-popular__title" id="popularTitle">Top 10</div>
          <div class="nav-popular__tabs" role="tablist" aria-label="Most Popular">
            <button class="nav-popular__tab is-active" type="button" data-popular-mode="trending" role="tab" aria-selected="true">üî• Trending</button>
            <button class="nav-popular__tab" type="button" data-popular-mode="all" role="tab" aria-selected="false">üèÜ All‚Äëtime</button>
          </div>
          <div class="nav-popular__updated" id="popularUpdated" aria-live="polite"></div>
        </div>
        <button class="nav-popular__close" type="button" aria-label="Close" id="popularClose">‚úï</button>
      </div>
      <div class="popular__scroll">
      <div class="popular__msg" id="popularMsg">Loading‚Ä¶</div>
      <ol class="popular__list" id="popularList"></ol>
    </div>
    </div>

    <main class="container main">
      {{ block "main" . }}{{ end }}
    </main>

    <footer class="footer">
      <div class="container footer__inner">
        <span>{{ now.Format "2006" }} ¬∑ {{ site.Title }}</span>
        <span class="footer__tagline">A centralised location for videogame related links. All credit goes to those on the end of each link.</span>
      </div>
    </footer>
  </div>

  {{/* Fingerprinted JS for the same reason as CSS (cache busting) */}}
  {{ $js := resources.Get "js/main.js" | minify | fingerprint }}
  <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous" defer></script>
  <script src="{{ "/js/theme.js" | relURL }}" defer></script>
  {{/* Randomize home card images every page load (uses data-random-srcs) */}}
  <script src="{{ "/js/home-random.js" | relURL }}" defer></script>
  {{ partial "search-data.html" . }}
<script src="{{ "/js/video-pill.js" | relURL }}"></script>

  {{/* Lazy-load game card images (works with 1,400+ items) */}}
  <script src="{{ "/js/lazy-images.js" | relURL }}" defer></script>

  {{/* Copy RSS URL buttons (desktop + mobile) */}}
  <script src="{{ "/js/rss-copy.js" | relURL }}" defer></script>

  {{/* Dev-only helper: copy the required image filename for any game card */}}
  {{ if hugo.IsServer }}
    <script src="{{ "/js/copy-filename.js" | relURL }}" defer></script>
  {{ end }}
    <script src="{{ "/js/admin-visibility.js" | relURL }}" defer></script>
{{ partial "cloudflare-analytics.html" . }}

<!-- Mastodon verification -->
<div class="mastodon-verification" style="display:none">
  <a rel="me" href="https://mastodon.social/@OldMcGroin">Mastodon</a>
  <a rel="me" href="https://retro-gaiden.com/@OldMcGroin">Mastodon</a>
</div>

</body>
</html>
