{{ define "main" }}
{{/* Prefer front-matter param if provided, otherwise use the page Title */}}
{{ $seriesName := .Params.series | default .Title }}
{{ $pageSlug := .Slug }}

<h1 class="page-title">{{ $seriesName | title }}</h1>

{{/* Exclude Abandonware (both old/new casing just in case) */}}
{{ $allGames := where site.Data.games "category" "not in" (slice "abandonware" "Abandonware") }}

{{/* Build matches: either exact series match OR slugified series matches this page slug */}}
{{ $games := slice }}
{{ range $allGames }}
  {{ $s := .series }}
  {{ if $s }}
    {{ $sSlug := $s | lower | urlize }}
    {{ if or (eq $s $seriesName) (eq $sSlug $pageSlug) }}
      {{ $games = $games | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $games = sort $games "title" "asc" }}

<div class="game-controls" data-game-grid>
  <div class="controls">
    <div class="control">
      <label>Sort</label>
      <select data-sort>
        <option value="az">Title (A to Z)</option>
        <option value="za">Title (Z to A)</option>
      </select>
    </div>
    <div class="control">
      <label>Genre</label>
      <select data-genre>
        <option value="All">All</option>
      </select>
    </div>
  </div>

  <div class="game-grid">
    {{ range $games }}
      {{ partial "game-card.html" (dict "game" . "ctx" $) }}
    {{ end }}
  </div>
</div>
{{ end }}

{{ define "preloads" }}
  {{ $seriesName := .Params.series | default .Title }}
  {{ $pageSlug := .Slug }}

  {{ $allGames := where site.Data.games "category" "not in" (slice "abandonware" "Abandonware") }}

  {{ $games := slice }}
  {{ range $allGames }}
    {{ $s := .series }}
    {{ if $s }}
      {{ $sSlug := $s | lower | urlize }}
      {{ if or (eq $s $seriesName) (eq $sSlug $pageSlug) }}
        {{ $games = $games | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $games = sort $games "title" "asc" }}

  {{ range first 6 $games }}
    {{ $img := partial "resolve-game-image.html" . }}
    {{ if ne $img "/Images/placeholder.jpg" }}
      <link rel="preload" as="image" href="{{ $img | relURL }}" fetchpriority="high" />
    {{ end }}
  {{ end }}
{{ end }}
