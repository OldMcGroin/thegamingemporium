{{ define "main" }}
{{/*
  Series pages are auto-generated from data/games.json.

  Historically the `series` field in games.json has sometimes been stored as:
  - a human name (e.g. "Animal Crossing")
  - a slug (e.g. "tux-games")

  To make series pages resilient, match games by:
  - exact (case-insensitive) series name
  - series slug (case-insensitive)
  - urlize(series name) == slug
*/}}

{{ $seriesKey := .Params.series | default .Title }}
{{ $slug := .Params.slug | default (urlize $seriesKey) }}

<h1 class="page-title">{{ .Title }}</h1>

{{ $all := where site.Data.games "category" "not in" (slice "abandonware" "Abandonware") }}
{{ $games := slice }}
{{ range $all }}
  {{ $game := . }}
  {{ with $game.series }}
    {{ $s := . }}
    {{ if or (eq (lower $s) (lower $seriesKey)) (eq (lower $s) (lower $slug)) (eq (lower (urlize $s)) (lower $slug)) }}
      {{ $games = $games | append $game }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $games = sort $games "title" "asc" }}

<div class="game-controls" data-game-grid>
  <div class="controls">
    <div class="control">
      <label>Sort</label>
      <select data-sort>
        <option value="az">Title (A to Z)</option>
        <option value="za">Title (Z to A)</option>
      </select>
    </div>
    <div class="control">
      <label>Genre</label>
      <select data-genre>
        <option value="All">All</option>
      </select>
    </div>
  </div>

  <div class="game-grid">
    {{ range $games }}
      {{ partial "game-card.html" (dict "game" . "ctx" $) }}
    {{ end }}
  </div>
</div>
{{ end }}

{{ define "preloads" }}
  {{ $seriesKey := .Params.series | default .Title }}
  {{ $slug := .Params.slug | default (urlize $seriesKey) }}
  {{ $all := where site.Data.games "category" "not in" (slice "abandonware" "Abandonware") }}
  {{ $games := slice }}
  {{ range $all }}
    {{ $game := . }}
    {{ with $game.series }}
      {{ $s := . }}
      {{ if or (eq (lower $s) (lower $seriesKey)) (eq (lower $s) (lower $slug)) (eq (lower (urlize $s)) (lower $slug)) }}
        {{ $games = $games | append $game }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $games = sort $games "title" "asc" }}
  {{ range first 6 $games }}
    {{ $img := partial "resolve-game-image.html" . }}
    {{ if ne $img "/Images/placeholder.jpg" }}
      <link rel="preload" as="image" href="{{ $img | relURL }}" fetchpriority="high" />
    {{ end }}
  {{ end }}
{{ end }}
