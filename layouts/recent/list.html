{{ define "main" }}
{{ $visibleGames := site.Data.games }}
{{ if not hugo.IsServer }}
  {{ $visibleGames = where $visibleGames "hidden" "ne" true }}
{{ end }}
<h1 class="page-title">Recent Additions</h1>
<p class="page-subtitle"></p>

{{/* 
  Sort by date_added DESC, and when multiple games share the same day,
  sort by their position in games.json (later entries first).
  This lets "newer entries added the same day" float to the top.
*/}}
{{ $enriched := slice }}
{{ range $i, $g := $visibleGames }}
  {{ if and (isset $g "date_added") (ne $g.date_added "") }}
    {{ $k := printf "%s-%09d" $g.date_added $i }}
    {{ $enriched = $enriched | append (dict "k" $k "g" $g) }}
  {{ end }}
{{ end }}
{{ $sorted := sort $enriched "k" "desc" }}

<div class="game-controls" data-game-grid>
  <div class="controls">
    <div class="control">
      <label>Category</label>
      <div class="genre-dropdown" data-category-dropdown>
        <button type="button" class="genre-dropdown-toggle" data-category-dropdown-toggle aria-expanded="false">
          Category â–¾
        </button>
        <div class="genre-dropdown-panel" data-category-dropdown-panel hidden>
          <div class="genre-chips" data-category-chips aria-label="Category filters"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="game-grid">
    {{ range $sorted }}
      {{ partial "game-card.html" (dict "game" .g "ctx" $) }}
    {{ end }}
  </div>
</div>
{{ end }}

{{ define "preloads" }}
  {{ $visibleGames := site.Data.games }}
{{ if not hugo.IsServer }}
  {{ $visibleGames = where $visibleGames "hidden" "ne" true }}
{{ end }}
  {{ $enriched := slice }}
  {{ range $i, $g := $visibleGames }}
    {{ if and (isset $g "date_added") (ne $g.date_added "") }}
      {{ $k := printf "%s-%09d" $g.date_added $i }}
      {{ $enriched = $enriched | append (dict "k" $k "g" $g) }}
    {{ end }}
  {{ end }}
  {{ $sorted := sort $enriched "k" "desc" }}
  {{ range first 6 $sorted }}
    {{ $img := partial "resolve-game-image.html" .g }}
    {{ if ne $img "/Images/placeholder.jpg" }}
      <link rel="preload" as="image" href="{{ $img | relURL }}" fetchpriority="high" />
    {{ end }}
  {{ end }}
{{ end }}
